<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dialecte ‚Äì Accueil</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="header">
    <a href="index.html" class="home-icon">üè†</a>
    <h1 class="logo">Dialecte</h1>
    <div class="header-auth" id="header-auth">
      <!-- Les boutons seront inject√©s ici par le script -->
    </div>
  </header>

  <nav class="mobile-nav">
    <a href="index.html">Lexique</a>
    <a href="discovery.html">D√©couvrir</a>
    <a href="review.html">R√©viser</a>
    <a href="quiz.html">Quiz Classique</a>
    <a href="progres.html">Mes progr√®s</a>
  </nav>

  <div class="layout">
    <nav class="sidebar">
      <ul>
        <li><a href="index.html">Lexique</a></li>
        <li><a href="discovery.html">D√©couvrir</a></li>
        <li><a href="review.html">R√©viser</a></li>
        <li><a href="quiz.html">Quiz Classique</a></li>
        <li><a href="progres.html">Mes progr√®s</a></li>
      </ul>
    </nav>

    <main class="main">
      <h2>Bienvenue sur Dialecte !</h2>
      
      <!-- Bloc explicatif p√©dagogique -->
      <section class="info-section" style="background:#f9fafc; border-left:4px solid #4F8A8B; padding:1.5em 1em; border-radius:8px; margin-bottom:2em; max-width:600px; margin-left:auto; margin-right:auto;">
        <b>D√©couvre, r√©vise, progresse !</b><br>
        Cette application t'aide √† apprendre le kabyle facilement :<br>
        <ul style="text-align:left; margin:0.7em auto 0.7em 1.2em; max-width:500px;">
          <li>D√©couvre de nouveaux mots adapt√©s √† ton niveau.</li>
          <li>R√©vise r√©guli√®rement gr√¢ce √† une m√©thode astucieuse de r√©p√©tition qui t'aide √† retenir durablement les mots importants.</li>
          <li>Joue √† des quiz pour t'entra√Æner et tester tes connaissances.</li>
        </ul>
        <span style="font-size:0.98em; color:#3b5c5c;">Tout ton historique de progression est sauvegard√© : tu peux reprendre o√π tu t'es arr√™t√©, sur n'importe quel appareil.</span>
      </section>

      <!-- Encadr√©s des trois types de jeu -->
      <section class="learning-modes" style="margin-bottom:2em;">
        <h3 style="text-align:center; margin-bottom:1.5em;">Modes d'apprentissage</h3>
        <div class="mode-cards" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:2em; max-width:900px; margin:0 auto;">
          <div class="mode-card" style="background:#fff; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.07); padding:2em 1em; text-align:center;">
            <h4 style="font-size:1.2em; margin-bottom:0.5em;">üîç Mode D√©couverte</h4>
            <p style="color:#4F8A8B; margin-bottom:1.2em;">Apprenez de nouveaux mots avec des quiz √† choix multiples</p>
            <a href="discovery.html" class="btn btn-primary">Commencer</a>
          </div>
          <div class="mode-card" style="background:#fff; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.07); padding:2em 1em; text-align:center;">
            <h4 style="font-size:1.2em; margin-bottom:0.5em;">üîÑ Mode R√©vision</h4>
            <p style="color:#4F8A8B; margin-bottom:1.2em;">R√©visez les mots appris avec la r√©p√©tition espac√©e</p>
            <a href="review.html" class="btn btn-secondary" id="review-btn">R√©viser (<span id="due-count">0</span>)</a>
          </div>
          <div class="mode-card" style="background:#fff; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.07); padding:2em 1em; text-align:center;">
            <h4 style="font-size:1.2em; margin-bottom:0.5em;">üéØ Quiz Classique</h4>
            <p style="color:#4F8A8B; margin-bottom:1.2em;">Testez vos connaissances avec le quiz traditionnel</p>
            <a href="quiz.html" class="btn btn-primary">Commencer</a>
          </div>
        </div>
      </section>

      <section id="lexique">
        <h2>Lexique th√©matique</h2>
        <div class="lexique-controls">
          <label for="theme-select">Filtrer par th√®me :</label>
          <select id="theme-select">
            <option value="all">Tous les th√®mes</option>
          </select>
        </div>
        <div id="lexique-content">Chargement du lexique‚Ä¶</div>
      </section>
    </main>
  </div>

  <!-- Bouton flottant Agent IA -->
  <button class="ai-chat-button" id="ai-chat-button" title="Assistant IA">
    ü§ñ
    <span class="ai-notification" id="ai-notification">!</span>
  </button>

  <!-- Fen√™tre Modal Agent IA -->
  <div class="ai-chat-modal" id="ai-chat-modal">
    <div class="ai-chat-container">
      <div class="ai-chat-header">
        <div class="ai-chat-title">
          <span class="ai-avatar">ü§ñ</span>
          <div>
            <h3>Assistant IA Dialecte</h3>
            <p>Votre compagnon d'apprentissage du kabyle</p>
          </div>
        </div>
        <button class="ai-chat-close" id="ai-chat-close">‚úï</button>
      </div>
      
      <div class="ai-chat-messages" id="ai-chat-messages">
        <div class="ai-message">
          <div class="ai-message-avatar">ü§ñ</div>
          <div class="ai-message-content">
            <p>Bonjour ! Je suis votre assistant IA pour l'apprentissage du kabyle. Je peux vous aider √† :</p>
            <ul>
              <li>Traduire des mots fran√ßais-kabyle</li>
              <li>Expliquer la grammaire kabyle</li>
              <li>Donner des conseils d'apprentissage</li>
              <li>R√©pondre √† vos questions sur la culture berb√®re</li>
            </ul>
            <p>Comment puis-je vous aider aujourd'hui ?</p>
          </div>
        </div>
      </div>
      
      <div class="ai-chat-input-container">
        <div class="ai-suggestions">
          <button class="ai-suggestion" data-text="Comment dit-on 'bonjour' en kabyle ?">Comment dit-on 'bonjour' en kabyle ?</button>
          <button class="ai-suggestion" data-text="Explique-moi les bases de la grammaire kabyle">Explique-moi les bases de la grammaire</button>
          <button class="ai-suggestion" data-text="Donne-moi des conseils pour apprendre efficacement">Conseils d'apprentissage</button>
        </div>
        <div class="ai-chat-input-wrapper">
          <input 
            type="text" 
            class="ai-chat-input" 
            id="ai-chat-input" 
            placeholder="Tapez votre message..."
            autocomplete="off"
          />
          <button class="ai-chat-send" id="ai-chat-send" disabled>
            <span class="send-icon">‚û§</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="cards.js"></script>
  <script type="module">
    import { auth, logout, initAuthListener } from "./firebase.js";

    const headerAuth = document.getElementById('header-auth');

    function renderAuthButtons(user) {
      headerAuth.innerHTML = '';
      if (user) {
        // Si connect√©, afficher Se d√©connecter
        const btn = document.createElement('button');
        btn.textContent = 'Se d√©connecter';
        btn.className = 'btn auth';
        btn.onclick = async () => {
          await logout();
          location.reload();
        };
        headerAuth.appendChild(btn);
      } else {
        // si non connect√©, afficher Se connecter / S'inscrire
        const login = document.createElement('a');
        login.href = 'login.html';
        login.textContent = 'Se connecter';
        login.className = 'btn auth';
        const signup = document.createElement('a');
        signup.href = 'signup.html';
        signup.textContent = "S'inscrire";
        signup.className = 'btn auth';
        headerAuth.append(login, signup);
      }
    }

    initAuthListener(user => {
      renderAuthButtons(user);
    });

    // Initialiser le gestionnaire de cartes et mettre √† jour le compteur
    async function updateDueCount() {
      await cardManager.loadCards();
      const stats = cardManager.getStats();
      document.getElementById('due-count').textContent = stats.due;
    }

    // Mettre √† jour le compteur au chargement
    updateDueCount();

    // Agent IA Chat Functionality
    const aiChatButton = document.getElementById('ai-chat-button');
    const aiChatModal = document.getElementById('ai-chat-modal');
    const aiChatClose = document.getElementById('ai-chat-close');
    const aiChatInput = document.getElementById('ai-chat-input');
    const aiChatSend = document.getElementById('ai-chat-send');
    const aiChatMessages = document.getElementById('ai-chat-messages');
    const aiNotification = document.getElementById('ai-notification');

    // Ouvrir/fermer le chat
    aiChatButton.addEventListener('click', () => {
      aiChatModal.classList.add('active');
      aiChatInput.focus();
      aiNotification.style.display = 'none';
    });

    aiChatClose.addEventListener('click', () => {
      aiChatModal.classList.remove('active');
    });

    // Fermer en cliquant √† l'ext√©rieur
    aiChatModal.addEventListener('click', (e) => {
      if (e.target === aiChatModal) {
        aiChatModal.classList.remove('active');
      }
    });

    // G√©rer l'input
    aiChatInput.addEventListener('input', () => {
      aiChatSend.disabled = !aiChatInput.value.trim();
    });

    aiChatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    aiChatSend.addEventListener('click', sendMessage);

    // Suggestions pr√©d√©finies
    document.querySelectorAll('.ai-suggestion').forEach(btn => {
      btn.addEventListener('click', () => {
        aiChatInput.value = btn.dataset.text;
        aiChatSend.disabled = false;
        sendMessage();
      });
    });

    function sendMessage() {
      const message = aiChatInput.value.trim();
      if (!message) return;

      // Ajouter le message de l'utilisateur
      addMessage(message, 'user');
      aiChatInput.value = '';
      aiChatSend.disabled = true;

      // Simuler la r√©ponse de l'IA apr√®s un d√©lai
      addTypingIndicator();
      setTimeout(() => {
        removeTypingIndicator();
        const response = generateAIResponse(message);
        addMessage(response, 'ai');
      }, 1000 + Math.random() * 1000);
    }

    function addMessage(content, sender) {
      const messageDiv = document.createElement('div');
      messageDiv.className = sender === 'user' ? 'user-message' : 'ai-message';
      
      if (sender === 'user') {
        messageDiv.innerHTML = `
          <div class="user-message-content">
            <p>${content}</p>
          </div>
          <div class="user-message-avatar">üë§</div>
        `;
      } else {
        messageDiv.innerHTML = `
          <div class="ai-message-avatar">ü§ñ</div>
          <div class="ai-message-content">
            <p>${content}</p>
          </div>
        `;
      }
      
      aiChatMessages.appendChild(messageDiv);
      aiChatMessages.scrollTop = aiChatMessages.scrollHeight;
    }

    function addTypingIndicator() {
      const typingDiv = document.createElement('div');
      typingDiv.className = 'ai-message typing-indicator';
      typingDiv.id = 'typing-indicator';
      typingDiv.innerHTML = `
        <div class="ai-message-avatar">ü§ñ</div>
        <div class="ai-message-content">
          <div class="typing-dots">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
      `;
      aiChatMessages.appendChild(typingDiv);
      aiChatMessages.scrollTop = aiChatMessages.scrollHeight;
    }

    function removeTypingIndicator() {
      const typingIndicator = document.getElementById('typing-indicator');
      if (typingIndicator) {
        typingIndicator.remove();
      }
    }

    function generateAIResponse(message) {
      const lowerMessage = message.toLowerCase();
      
      // R√©ponses pr√©programm√©es simples
      if (lowerMessage.includes('bonjour') || lowerMessage.includes('azul')) {
        return "Azul ! En kabyle, on dit 'Azul' pour dire bonjour. C'est un salut traditionnel berb√®re qui signifie litt√©ralement 'que tu sois b√©ni'. Vous pouvez aussi dire 'Azul fellak' (√† un homme) ou 'Azul fellik' (√† une femme).";
      }
      
      if (lowerMessage.includes('grammaire')) {
        return "La grammaire kabyle est fascinante ! Voici les bases :\n\n‚Ä¢ Les noms ont un genre (masculin/f√©minin)\n‚Ä¢ Les verbes se conjuguent selon la personne\n‚Ä¢ L'ordre des mots est g√©n√©ralement Verbe-Sujet-Objet\n‚Ä¢ Il y a un √©tat libre et un √©tat d'annexion pour les noms\n\nVoulez-vous que je vous explique un point particulier ?";
      }
      
      if (lowerMessage.includes('conseil') || lowerMessage.includes('apprendre')) {
        return "Voici mes conseils pour bien apprendre le kabyle :\n\nüéØ Pratiquez r√©guli√®rement (15-20 min/jour)\nüì± Utilisez les modes D√©couverte et R√©vision\nüéµ √âcoutez de la musique kabyle\nüìö Commencez par les mots du quotidien\nüí¨ Essayez de parler d√®s que possible\n\nLa r√©p√©tition espac√©e de cette app vous aidera √©norm√©ment !";
      }
      
      if (lowerMessage.includes('merci') || lowerMessage.includes('tanemmirt')) {
        return "Tanemmirt ! (De rien !) C'est avec plaisir que je vous aide dans votre apprentissage du kabyle. N'h√©sitez pas si vous avez d'autres questions !";
      }
      
      if (lowerMessage.includes('famille')) {
        return "Voici les mots de famille en kabyle :\n\n‚Ä¢ P√®re : Baba / Vava\n‚Ä¢ M√®re : Yemma / Mama\n‚Ä¢ Fr√®re : Gma\n‚Ä¢ S≈ìur : Weltma\n‚Ä¢ Fils : Mmi-s / Qcic\n‚Ä¢ Fille : Yelli-s / Taqcict\n‚Ä¢ Grand-p√®re : Jeddi\n‚Ä¢ Grand-m√®re : Nana\n\nCes mots sont essentiels dans la vie quotidienne !";
      }
      
      // R√©ponse g√©n√©rale
      return "Merci pour votre question ! Je fais de mon mieux pour vous aider. Pour des traductions sp√©cifiques, n'h√©sitez pas √† consulter le lexique de l'application. Vous pouvez aussi me poser des questions plus pr√©cises sur la grammaire, la pronunciation ou la culture berb√®re.";
    }

    // Afficher une notification au bout de 5 secondes
    setTimeout(() => {
      aiNotification.style.display = 'block';
    }, 5000);

    // G√©n√©ration dynamique du lexique √† partir de data3.csv
    const THEMES = [
      { nom: 'Verbes', mots: ['√™tre','venir','dire','voir','faire','manger','boire','prendre','aller','accompagner','jurer','tisser','r√©aliser','armer'] },
      { nom: 'Nature', mots: ['eau','arbre','ciel','soleil','lune','terre','vent','montagne','herbe','mer','foin','boue','baie','oasis'] },
      { nom: 'Corps humain', mots: ['main','t√™te','jambe','nez','bouche','≈ìil','oreille','pied','dent','dos','cou','peau','sein','sang'] },
      { nom: 'Animaux', mots: ['chat','bouc','hy√®ne','√¢ne','chien','oiseau','poisson','vache','mouton','cheval'] },
      { nom: 'Nourriture', mots: ['pain','lait','fromage','viande','fruit','l√©gume','miel','bi√®re','melon','noix'] },
      { nom: 'Maison', mots: ['maison','porte','fen√™tre','chambre','lit','cuisine','table','chaise','cl√©'] },
      { nom: 'V√™tements', mots: ['chemise','pantalon','robe','manteau','chapeau','chaussure','tablier'] },
      { nom: 'Couleurs', mots: ['bleu','blanc','noir','rouge','vert','jaune','gris'] },
      { nom: 'Famille', mots: ['p√®re','m√®re','fr√®re','soeur','fils','fille','oncle','tante','grand-m√®re','grand-p√®re'] },
      { nom: 'Objets du quotidien', mots: ['table','chaise','porte','fen√™tre','lit','bol','cuir','bouteille','cl√©'] }
    ];
    function detectTheme(fr) {
      for (const t of THEMES) {
        for (const mot of t.mots) {
          if (fr.toLowerCase().includes(mot)) return t.nom;
        }
      }
      return 'Autres';
    }
    function renderLexique(data) {
      const themes = {};
      data.forEach(row => {
        const fr = row['Fran√ßais']?.trim();
        const kab = row['Kabyle']?.trim();
        if (!fr || !kab) return;
        const theme = detectTheme(fr);
        if (!themes[theme]) themes[theme] = [];
        // S√©parer les traductions multiples
        const traductions = kab.split('/').map(t => t.trim()).filter(t => t);
        themes[theme].push({ fr, kab });
      });
      // Remplir dynamiquement le menu d√©roulant avec les th√®mes d√©tect√©s
      const themeSelect = document.getElementById('theme-select');
      themeSelect.innerHTML = '<option value="all">Tous les th√®mes</option>';
      Object.keys(themes).forEach(theme => {
        const option = document.createElement('option');
        option.value = theme;
        option.textContent = theme;
        themeSelect.appendChild(option);
      });
      // Affichage filtr√©
      function displayLexique(selectedTheme = 'all') {
        let html = '';
        Object.keys(themes).forEach(theme => {
          if (selectedTheme === 'all' || theme === selectedTheme) {
            html += `<div class='lexique-theme'><h3>${theme}</h3><ul class='lexique-list'>`;
            themes[theme].forEach(({fr, kab}) => {
              html += `<li><span class='fr'>${fr}</span> <span class='kab'>${kab}</span></li>`;
            });
            html += '</ul></div>';
          }
        });
        document.getElementById('lexique-content').innerHTML = html;
      }
      displayLexique();
      themeSelect.addEventListener('change', (e) => {
        displayLexique(e.target.value);
      });
    }
    Papa.parse('/data3.csv', {
      download: true,
      header: true,
      skipEmptyLines: true,
      delimiter: ';',
      complete: ({ data }) => renderLexique(data)
    });
  </script>
</body>
</html>