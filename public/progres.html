<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dialect â€“ Mes progrÃ¨s</title>
  <link rel="stylesheet" href="styles/style.css?v=4" />
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="icon" type="image/png" href="images/logo.png" />
</head>

<body>
  <button class="mobile-menu-btn">â˜°</button>
  <div class="mobile-menu-bg"></div>
  <nav class="mobile-menu">
    <a href="index.html">ğŸ  Accueil</a>
    <a href="review.html">ğŸ§  Apprendre</a>
    <a href="progres.html">ğŸ“ˆ ProgrÃ¨s</a>
    <a href="login.html">ğŸ” Connexion</a>
  </nav>
  <nav>
    <a href="index.html" class="logo">Dialect</a>
    <div class="nav-links">
      <a href="index.html">Accueil</a>
      <a href="review.html">Apprendre</a>
      <a href="progres.html" class="active">ProgrÃ¨s</a>
      <a href="login.html">Connexion</a>
    </div>
    <div class="nav-actions">
      <a href="login.html" class="btn btn-purple">Se connecter</a>
      <a href="signup.html" class="btn btn-yellow">S'inscrire</a>
    </div>
  </nav>

  <main>
    <!-- Hero Section -->
    <section class="progress-hero">
      <div class="hero-bg-anim"></div>
      <div class="hero-content">
        <div id="level-badge" class="level-badge">Niveau 1</div>
        <h1 id="welcome-message">Bienvenue !</h1>
        <p class="subtitle">Continue sur ta lancÃ©e pour devenir un expert du kabyle.</p>
      </div>
    </section>

    <!-- Dashboard Grid -->
    <div class="main-dashboard">

      <!-- Left: Progress Ring -->
      <div class="progress-ring-card">
        <h3>Lexique MaÃ®trisÃ©</h3>
        <div style="position: relative; width: 180px; height: 180px; margin-top: 1rem;">
          <svg class="progress-ring" width="180" height="180">
            <circle class="progress-ring__circle-bg" stroke="rgba(255,255,255,0.1)" stroke-width="12" fill="transparent"
              r="80" cx="90" cy="90" />
            <circle class="progress-ring__circle" id="progress-circle" stroke="#00C853" stroke-width="12"
              fill="transparent" r="80" cx="90" cy="90" stroke-dasharray="502" stroke-dashoffset="502" />
          </svg>
          <div class="progress-text-centered">
            <span class="progress-percentage" id="progress-percent-hero">0%</span>
          </div>
        </div>
        <p class="progress-label" style="margin-top: 1rem;"><span id="learned-count-hero">0</span> mots appris sur <span
            id="total-count-hero">0</span></p>
      </div>

      <!-- Right: Key Stats -->
      <div class="stats-grid-small">

        <!-- Streak Card -->
        <div class="mini-stat-card">
          <div class="mini-stat-icon">ğŸ”¥</div>
          <div class="mini-stat-info">
            <h4>SÃ©rie actuelle</h4>
            <div class="mini-stat-value" id="streak-count">0 jours</div>
          </div>
        </div>

        <!-- Due Card -->
        <div class="mini-stat-card">
          <div class="mini-stat-icon">ğŸ”„</div>
          <div class="mini-stat-info">
            <h4>Ã€ rÃ©viser</h4>
            <div class="mini-stat-value" id="due-count-hero">0</div>
          </div>
        </div>

        <!-- Quiz Performance -->
        <div class="mini-stat-card">
          <div class="mini-stat-icon">ğŸ†</div>
          <div class="mini-stat-info">
            <h4>Quiz Classique</h4>
            <div class="mini-stat-value" id="quiz-score-global">0/0</div>
          </div>
        </div>

        <!-- Next Goal -->
        <div class="mini-stat-card">
          <div class="mini-stat-icon">ğŸ¯</div>
          <div class="mini-stat-info">
            <h4>Prochain Objectif</h4>
            <div class="mini-stat-value">Niveau <span id="next-level">2</span></div>
          </div>
        </div>

      </div>
    </div>

    <!-- Call to Action -->
    <div class="action-area" id="action-area" style="display:none;">
      <a href="review.html" class="btn-large-cta">Lancer ma session du jour ğŸš€</a>
    </div>

    <!-- Recent History -->
    <section class="card stats-section" style="margin-top: 3rem;">
      <h3>ğŸ“… ActivitÃ© RÃ©cente</h3>
      <div id="history-container">
        <p style="text-align: center; color: var(--text-muted);">Chargement de l'activitÃ©...</p>
      </div>
    </section>

  </main>

  <footer>
    Â© 2025 Dialect
  </footer>

  <script src="ui.js" type="module"></script>

  <!-- Script pour le menu mobile -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const menuBtn = document.querySelector('.mobile-menu-btn');
      const mobileMenu = document.querySelector('.mobile-menu');
      const mobileMenuBg = document.querySelector('.mobile-menu-bg');

      // Ouvrir le menu
      menuBtn.addEventListener('click', function () {
        mobileMenu.classList.add('open');
        mobileMenuBg.classList.add('open');
      });

      // Fermer le menu en cliquant sur le fond
      mobileMenuBg.addEventListener('click', function () {
        mobileMenu.classList.remove('open');
        mobileMenuBg.classList.remove('open');
      });

      // Fermer le menu en cliquant sur un lien
      const menuLinks = mobileMenu.querySelectorAll('a');
      menuLinks.forEach(link => {
        link.addEventListener('click', function () {
          mobileMenu.classList.remove('open');
          mobileMenuBg.classList.remove('open');
        });
      });
    });
  </script>

  <script type="module">
    import { auth, logout, initAuthListener, getUserLevel, getScore } from "./firebase.js";
    import { renderNavAuthButtons } from "./ui.js";

    initAuthListener(async user => {
      renderNavAuthButtons(user);

      const welcomeMsg = document.getElementById('welcome-message');
      const levelBadge = document.getElementById('level-badge');
      const actionArea = document.getElementById('action-area');

      if (user) {
        if (user.displayName) welcomeMsg.textContent = `Content de te revoir, ${user.displayName.split(' ')[0]} !`;

        try {
          // Charger le niveau
          const level = await getUserLevel(user.uid);
          levelBadge.textContent = `Niveau ${level}`;
          document.getElementById('next-level').textContent = level + 1;

          // Charger les stats via cardManager
          await updateDashboard(level, user.uid);

          actionArea.style.display = 'block';
        } catch (error) {
          console.error('[ERROR] Erreur chargement tableau de bord:', error);
          document.getElementById('history-container').innerHTML =
            `<p style="text-align: center; color: #ff5252;">Erreur lors du chargement des donnÃ©es (${error.message}). <br>Veuillez rafraÃ®chir la page.</p>`;
        }
      } else {
        welcomeMsg.textContent = 'Bienvenue sur Dialect !';
        levelBadge.style.display = 'none';
        actionArea.style.display = 'none';
        document.getElementById('history-container').innerHTML = '<p style="text-align: center;">Connecte-toi pour voir tes progrÃ¨s.</p>';
      }
    });

    async function updateDashboard(level, uid) {
      await cardManager.loadCards(uid);
      const stats = cardManager.getStats();
      const globalScore = await getScore(uid); // Nouveau : RÃ©cupÃ©rer les stats globales Quiz

      // 1. Cercle de progression
      const circle = document.getElementById('progress-circle');
      const radius = circle.r.baseVal.value;
      const circumference = radius * 2 * Math.PI;

      circle.style.strokeDasharray = `${circumference} ${circumference}`;
      circle.style.strokeDashoffset = circumference;

      const offset = circumference - (stats.progress / 100) * circumference;
      // Petit dÃ©lai pour l'animation
      setTimeout(() => {
        circle.style.strokeDashoffset = offset;
      }, 500);

      document.getElementById('progress-percent-hero').textContent = `${stats.progress}%`;
      document.getElementById('learned-count-hero').textContent = stats.learned;
      document.getElementById('total-count-hero').textContent = stats.total;

      // 2. Stats Grid
      document.getElementById('streak-count').textContent = `${stats.streak} jour${stats.streak > 1 ? 's' : ''}`;
      // Animation feu si streak > 0
      if (stats.streak > 0) {
        document.getElementById('streak-count').innerHTML = `${stats.streak} jour${stats.streak > 1 ? 's' : ''} ğŸ”¥`;
      }

      document.getElementById('due-count-hero').textContent = stats.due;
      if (stats.due > 0) {
        document.getElementById('due-count-hero').style.color = '#FFD700'; // Gold warning
      }

      document.getElementById('quiz-score-global').textContent = `${globalScore.correctAnswers}/${globalScore.totalAnswers}`;

      // 3. Historique RÃ©cent
      displayRecentActivity(level);
    }

    function displayRecentActivity(level) {
      const container = document.getElementById('history-container');
      const history = [];

      cardManager.cards.forEach(card => {
        if (card.history && card.history.length > 0) {
          card.history.forEach(h => {
            history.push({
              fr: card.fr,
              kab: card.kab,
              date: new Date(h.date),
              quality: h.quality
            });
          });
        }
      });

      // Trier par date dÃ©croissante
      history.sort((a, b) => b.date - a.date);
      // Prendre les 5 derniers
      const recent = history.slice(0, 5);

      if (recent.length === 0) {
        container.innerHTML = '<p style="text-align:center; opacity:0.7;">Aucune activitÃ© rÃ©cente.</p>';
        return;
      }

      let html = '<div class="history-list">';
      recent.forEach(item => {
        const isMastered = item.quality >= 4;
        const icon = isMastered ? 'âœ¨' : 'ğŸ“';
        const color = isMastered ? '#4CAF50' : '#FF9800';

        html += `
          <div class="history-item">
            <div style="font-size: 1.2rem; margin-right: 1rem;">${icon}</div>
            <div class="history-word">
              <strong>${item.fr}</strong>
              <div style="font-size: 0.85rem; opacity: 0.7;">${item.kab}</div>
            </div>
            <div class="history-details">
              <span class="history-date">${item.date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' })}</span>
              <span class="history-quality" style="color: ${color}">${isMastered ? 'MaÃ®trisÃ©' : 'RÃ©visÃ©'}</span>
            </div>
          </div>
        `;
      });
      html += '</div>';
      container.innerHTML = html;
    }
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const path = window.location.pathname.split('/').pop();
      document.querySelectorAll('.mobile-tabbar a').forEach(link => {
        if (link.getAttribute('href') === path) {
          link.classList.add('active');
        }
      });
    });
  </script>
  <script>
    // Active link dans le menu burger
    document.addEventListener('DOMContentLoaded', function () {
      const path = window.location.pathname.split('/').pop();
      document.querySelectorAll('.burger-menu a').forEach(link => {
        if (link.getAttribute('href') === path) {
          link.classList.add('active');
        }
      });
    });
  </script>
</body>

</html>