<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dialecte â€“ Mes progrÃ¨s</title>
  <link rel="stylesheet" href="../styles/style.css"/>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
</head>
<body>
  <nav>
    <div class="logo">Dialecte.</div>
    <div class="nav-links">
      <a href="index.html">Accueil</a>
      <a href="quiz.html">Quiz</a>
      <a href="review.html">RÃ©viser</a>
      <a href="progres.html" class="active">ProgrÃ¨s</a>
      <a href="login.html">Connexion</a>
    </div>
    <div class="nav-actions">
      <a href="login.html" class="btn btn-purple">Se connecter</a>
      <a href="signup.html" class="btn btn-yellow">S'inscrire</a>
    </div>
  </nav>

  <main>
    <section class="main-card">
      <h1>Mes progrÃ¨s</h1>
      <div id="welcome" class="welcome-text">Bienvenue !</div>
      <div id="username" class="username-text"></div>
    </section>

    <section class="card stats-section">
      <h3>ðŸ§  GrÃ¢ce Ã  la rÃ©pÃ©tition intelligente, tu mÃ©morises durablement les mots importants.</h3>
      <div class="stats-overview">
        <div class="stat-card">
          <h4>ðŸ“š Cartes apprises</h4>
          <div class="stat-number" id="learned-cards">0</div>
          <div class="stat-label">sur <span id="total-cards">0</span> disponibles</div>
        </div>
        <div class="stat-card">
          <h4>ðŸ”„ Ã€ rÃ©viser</h4>
          <div class="stat-number" id="due-cards">0</div>
          <div class="stat-label">cartes dues aujourd'hui</div>
        </div>
        <div class="stat-card">
          <h4>ðŸ“ˆ Progression</h4>
          <div class="stat-number" id="progress-percent">0%</div>
          <div class="stat-label">du lexique maÃ®trisÃ©</div>
        </div>
      </div>
    </section>

    <section class="card stats-section">
      <h3>ðŸŽ¯ Quiz Classique</h3>
      <div class="score-summary">
        <div class="score-label">Taux de rÃ©ussite :</div>
        <div class="progress-bar"><div id="progress-fill" class="progress-fill"></div></div>
        <div id="progress-percent-old" class="progress-percent">0 %</div>
      </div>
    </section>

    <section class="card stats-section">
      <h3>ðŸ“… Historique des rÃ©visions (SM-2)</h3>
      <div id="history-container">
        <p>Chargement de l'historique...</p>
      </div>
    </section>
  </main>

  <footer>
    Â© 2025 Dialecte
  </footer>

  <script type="module" src="ui.js"></script>
  <script type="module">
    import { auth, logout, initAuthListener, getScore, getUserLevel } from "./firebase.js";
    import { renderNavAuthButtons } from "./ui.js";

    initAuthListener(user => {
      renderNavAuthButtons(user);
      // Masquer l'onglet 'Se connecter' si connectÃ©
      const loginLink = document.getElementById('sidebar-login-link');
      if (loginLink) {
        loginLink.style.display = user ? 'none' : '';
      }
    });

    // Afficher l'historique des rÃ©visions (adaptÃ© au niveau courant)
    function displayRevisionHistory(niveauCourant) {
      const historyContainer = document.getElementById('history-container');
      try {
        // Log pour vÃ©rifier le contenu de toutes les cartes et leurs historiques
        console.log('[DEBUG] Affichage historique : cardManager.cards =', cardManager.cards);
        // RÃ©cupÃ©rer toutes les rÃ©visions de toutes les cartes du niveau courant
        let allRevisions = [];
        cardManager.cards.forEach(card => {
          if (card.niveau === niveauCourant && card.history && card.history.length > 0) {
            card.history.forEach(rev => {
              allRevisions.push({
                fr: card.fr,
                kab: card.kab,
                date: rev.date,
                quality: rev.quality
              });
            });
          }
        });
        // Trier par date dÃ©croissante
        allRevisions.sort((a, b) => new Date(b.date) - new Date(a.date));
        if (allRevisions.length === 0) {
          historyContainer.innerHTML = '<p>Aucune rÃ©vision effectuÃ©e pour ce niveau pour le moment.</p>';
        } else {
          let html = '<div class="history-list">';
          allRevisions.forEach(rev => {
            const date = new Date(rev.date).toLocaleDateString('fr-FR');
            const quality = rev.quality;
            const qualityText = quality >= 4 ? 'Excellent' : quality >= 3 ? 'Correct' : 'Difficile';
            const qualityColor = quality >= 4 ? '#4CAF50' : quality >= 3 ? '#FF9800' : '#E53935';
            html += `
              <div class="history-item">
                <div class="history-word">
                  <strong>${rev.fr}</strong> â†’ ${rev.kab}
                </div>
                <div class="history-details">
                  <span class="history-date">${date}</span>
                  <span class="history-quality" style="color: ${qualityColor}">${qualityText}</span>
                </div>
              </div>
            `;
          });
          html += '</div>';
          historyContainer.innerHTML = html;
        }
      } catch (e) {
        historyContainer.innerHTML = '<p>Erreur lors du chargement de l\'historique.</p>';
        console.error('Erreur historique:', e);
      }
    }

    // Mettre Ã  jour les statistiques SM-2 (adaptÃ©es au niveau courant)
    async function updateStats(niveauCourant) {
      await cardManager.loadCards();
      // Filtrer les cartes du niveau courant
      const cardsNiveau = cardManager.cards.filter(c => c.niveau === niveauCourant);
      const learned = cardsNiveau.filter(c => c.repetition > 0).length;
      const total = cardsNiveau.length;
      const due = cardsNiveau.filter(c => new Date(c.dueDate) <= new Date()).length;
      const progress = total > 0 ? Math.round((learned / total) * 100) : 0;
      document.getElementById('learned-cards').textContent = learned;
      document.getElementById('total-cards').textContent = total;
      document.getElementById('due-cards').textContent = due;
      document.getElementById('progress-percent').textContent = progress + '%';
      // Afficher l'historique des rÃ©visions pour ce niveau
      displayRevisionHistory(niveauCourant);
    }

    // Afficher le niveau courant dans la page
    function displayNiveau(niveauCourant) {
      let statsSection = document.querySelector('.stats-section');
      if (statsSection && !document.getElementById('niveau-courant')) {
        const niveauDiv = document.createElement('div');
        niveauDiv.id = 'niveau-courant';
        niveauDiv.style = 'font-size:1.2em; font-weight:600; color:#4F8A8B; margin-bottom:1em;';
        niveauDiv.innerHTML = `Niveau actuel : <span style="color:#bfa100;">${niveauCourant}</span>`;
        statsSection.insertBefore(niveauDiv, statsSection.firstChild);
      } else if (statsSection) {
        document.getElementById('niveau-courant').innerHTML = `Niveau actuel : <span style="color:#bfa100;">${niveauCourant}</span>`;
      }
    }

    // Progression utilisateur (quiz classique)
    initAuthListener(async user => {
      const w = document.getElementById('welcome');
      const u = document.getElementById('username');
      const fill = document.getElementById('progress-fill');
      const pct  = document.getElementById('progress-percent-old');
      let niveauCourant = 1;
      if (user && user.displayName) {
        w.textContent = 'Bienvenue !';
        u.textContent = user.displayName;
        const { totalAnswers, correctAnswers } = await getScore(user.uid);
        const percent = totalAnswers
          ? Math.round((correctAnswers/totalAnswers)*100)
          : 0;
        fill.style.width = percent+'%';
        pct.textContent  = percent+' %';
        // RÃ©cupÃ©rer le niveau courant depuis Firebase
        niveauCourant = await getUserLevel(user.uid);
      } else {
        w.textContent = 'Bienvenue invitÃ© !';
        u.textContent = '';
        fill.style.width = '0%';
        pct.textContent  = '0 %';
      }
      // Afficher le niveau courant
      displayNiveau(niveauCourant);
      // Mettre Ã  jour les nouvelles statistiques pour ce niveau
      await updateStats(niveauCourant);
    });
  </script>
</body>
</html>